name: Build Stealth Resetprop Mod

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: 'yxsra/MagiskResetPropMod'
          fetch-depth: 0

      - name: Install NDK (Official Method)
        run: |
          # Tải NDK r26b trực tiếp từ máy chủ Google
          wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip -q android-ndk-r26b-linux.zip
          # Thiết lập biến môi trường để dùng cho các bước sau
          echo "ANDROID_NDK_ROOT=$(pwd)/android-ndk-r26b" >> $GITHUB_ENV

      - name: Stealth Patching (Xóa dấu vết)
        run: |
          # 1. Xóa sạch các dòng printf/fprintf để tránh bị app ngân hàng quét chuỗi
          sed -i 's/printf(/ \/\/ /g' src/main.cpp
          sed -i 's/fprintf(/ \/\/ /g' src/main.cpp
          # 2. Vô hiệu hóa log trong các file nguồn khác
          sed -i 's/printf(/ \/\/ /g' src/resetprop.cpp
          sed -i 's/fprintf(/ \/\/ /g' src/resetprop.cpp

      - name: Compile Static Binary
        run: |
          # Thiết lập đường dẫn compiler từ NDK vừa tải
          export TOOLCHAIN=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64
          export CLANG=$TOOLCHAIN/bin/aarch64-linux-android33-clang++

          # Biên dịch trực tiếp:
          # -Iinclude: Để tìm các file header của dự án
          # -Os: Tối ưu dung lượng nhỏ nhất
          # -static: Ép build tĩnh hoàn toàn (không phụ thuộc libc.so hệ thống)
          # -s: Strip sạch bảng ký hiệu (Symbol table)
          $CLANG \
            -Iinclude \
            -Isrc \
            src/main.cpp \
            src/resetprop.cpp \
            src/system_properties.cpp \
            src/util.cpp \
            -std=c++17 \
            -Os \
            -static \
            -fdata-sections -ffunction-sections \
            -Wl,--gc-sections \
            -fvisibility=hidden \
            -fno-rtti \
            -fno-exceptions \
            -s \
            -o miui_sys_helper

      - name: Verify Binary Integrity
        run: |
          ls -al miui_sys_helper
          # Kiểm tra xem có đúng là Static và Stripped không
          file miui_sys_helper

      - name: Upload Stealth Binary
        uses: actions/upload-artifact@v4
        with:
          name: miui_sys_helper_static
          path: miui_sys_helper
