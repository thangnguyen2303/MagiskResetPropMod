name: Build Stealth Resetprop Mod

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: 'thangnguyen2303/MagiskResetPropMod'
          fetch-depth: 0

      - name: Install NDK
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip -q android-ndk-r26b-linux.zip
          echo "ANDROID_NDK_ROOT=$(pwd)/android-ndk-r26b" >> $GITHUB_ENV

      - name: Stealth Patching & Compile
        run: |
          export TOOLCHAIN=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64
          export CLANG=$TOOLCHAIN/bin/aarch64-linux-android33-clang++
          
          SRC_DIR="app/src/main/cpp/prop"
          SYS_PROP_INC_ROOT="app/src/main/cpp/system_properties/include"

          # Stealth Patching AN TOÀN: 
          # Thay vì chèn vào dòng 1, ta chèn vào sau các dòng #include
          # Cách tốt nhất là dùng cờ compiler -D để biến chúng thành rỗng mà không hại đến header hệ thống
          
          # Đổi tên nhận diện chuỗi trong code
          find "$SRC_DIR" -name "*.cpp" -exec sed -i 's/"resetprop"/"sys_helper"/g' {} +

          # Biên dịch với các Flag định nghĩa rỗng cho printf/fprintf
          # -D'printf(...)=(void)0' : Biến mọi lệnh printf thành lệnh trống
          $CLANG \
            -I $SRC_DIR \
            -I $SYS_PROP_INC_ROOT \
            -I $SYS_PROP_INC_ROOT/platform/bionic \
            $SRC_DIR/prop.cpp $SRC_DIR/resetprop.cpp \
            -std=c++17 \
            -Os \
            -static \
            -D_GNU_SOURCE \
            -D'printf(...)=(void)0' \
            -D'fprintf(...)=(void)0' \
            -Wno-c99-extensions \
            -Wno-format-invalid-specifier \
            -Wno-format-extra-args \
            -fdata-sections -ffunction-sections \
            -Wl,--gc-sections \
            -fvisibility=hidden \
            -fno-rtti \
            -fno-exceptions \
            -s \
            -o miui_sys_helper

      - name: Verify Binary
        run: |
          if [ -f miui_sys_helper ]; then
            ls -al miui_sys_helper
            file miui_sys_helper
          else
            echo "Biên dịch thất bại!"
            exit 1
          fi

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: miui_sys_helper_static
          path: miui_sys_helper
